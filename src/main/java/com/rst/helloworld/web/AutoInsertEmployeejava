package com.rst.helloworldId.web;

import javax.servlet.ServletContextEvent;
import javax.servlet.ServletContextListener;
import javax.servlet.annotation.WebListener;
import java.sql.*;
import java.util.Random;
import java.util.concurrent.*;

@WebListener
public class AutoInsertEmployeeListener implements ServletContextListener {

    private ScheduledExecutorService scheduler;

    @Override
    public void contextInitialized(ServletContextEvent sce) {
        scheduler = Executors.newSingleThreadScheduledExecutor();

        Runnable task = () -> {
            try {
                String host = System.getenv().getOrDefault("DB_HOST", "db");
                String db   = System.getenv().getOrDefault("DB_NAME", "employees_db");
                String user = System.getenv().getOrDefault("DB_USER", "aya");
                String pass = System.getenv().getOrDefault("DB_PASS", "aya");

                String url = "jdbc:mysql://" + host + ":3306/" + db +
                        "?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC";

                try (Connection conn = DriverManager.getConnection(url, user, pass)) {

                    String[] noms = {"Souki", "Trabelsi", "Omezzine", "Ayari"};
                    String[] prenoms = {"Aya", "Souhir", "Nour", "Mohamed"};
                    String[] villes = {"Tunis", "Monastir", "Sousse", "Sfax"};

                    Random r = new Random();

                    PreparedStatement ps = conn.prepareStatement(
                        "INSERT INTO employe (nom, prenom, ville) VALUES (?, ?, ?)"
                    );
                    ps.setString(1, noms[r.nextInt(noms.length)]);
                    ps.setString(2, prenoms[r.nextInt(prenoms.length)]);
                    ps.setString(3, villes[r.nextInt(villes.length)]);
                    ps.executeUpdate();

                    System.out.println("[AUTO-INSERT] Employee inserted");
                }
            } catch (Exception e) {
                System.out.println("[AUTO-INSERT] ERROR: " + e.getMessage());
            }
        };

        scheduler.scheduleAtFixedRate(task, 5, 30, TimeUnit.SECONDS);
        System.out.println("[AUTO-INSERT] Scheduler started (30s)");
    }

    @Override
    public void contextDestroyed(ServletContextEvent sce) {
        if (scheduler != null) scheduler.shutdownNow();
    }
}
